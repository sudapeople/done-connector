# Minecraft Chzzk / Soop 후원 연동 플러그인

## **지원 버전**
Java 버전: 21 이상, 17

※ Java 17 버전은 아래 다운로드에서 17버전을 다운받고 파일명에서 -jdk17을 제거 후 사용해주세요. 마인크래프트 1.20.4까지만 공식 지원 됩니다.

마인크래프트 서버 버전: Paper 1.20.x ~ 1.21.x (전체 테스트 통과)

## **실행 방법**

1. plugins 폴더에 done-connector-1.11.8.jar 파일을 넣고 마인크래프트 서버를 1회 실행 후 종료
2. plugins 폴더에서 done-connector/config.yml 파일 수정
3. 마인크래프트 서버 실행


## **사용 방법**

* 플러그인 적용 후 서버 실행 시, config.yml의 자동연결 설정에 따라 동작
* 자동연결 설정이 false(기본값)면 방송인이 서버에 접속할 때만 해당 채널 연결
* 자동연결 설정이 true면 서버 시작 시 모든 채널 자동 연결

### 명령어

#### 기본 후원 기능 명령어
* `/done [on|off|connect|reconnect|reload|add|list|autoconnect|test|ranking|stats]` 명령어로 기능 제어
* `/done on` 후원자 연동 기능 활성화 (모든 채널 연결)
* `/done off` 후원자 연동 기능 비활성화 (모든 채널 연결 해제)
* `/done connect <플랫폼> <닉네임>` 특정 플랫폼의 특정 채널에 수동으로 연결. 플랫폼은 '치지직' 또는 '숲'
* `/done reconnect all` 전체 재접속
* `/done reconnect <닉네임>` 해당 닉네임 재접속, 컨피그에서 치지직/숲 바로 아래 단계의 닉네임 혹은 마크닉네임 입력, 자동완성은 마크닉네임만 지원
* `/done reload` 설정 파일 리로드 및 재접속
* `/done add <플랫폼> <방송닉> <방송ID> <마크닉>` 도네연결 임시 추가, reload가 어려운 상황에서 임시로 연결 추가. 서버 재기동시에 없어짐
* `/done list` 현재 설정된 채널 목록 확인
* `/done autoconnect` 자동 연결 기능 토글 (활성화/비활성화)
* `/done test <치지직/숲> <방송채널명> <후원금액>` 후원 테스트 실행. 방송채널명은 config.yml에 설정된 채널명을 사용하며, 후원금액은 자유롭게 입력 가능 (자동완성 지원: 1000, 3000, 5000, 10000, 50000, 100000)
* `/done ranking <스트리머 플레이어> [페이지]` 스트리머의 후원 랭킹 조회. 페이지 번호를 생략하면 1페이지가 표시됩니다. (자동완성 지원)
* `/done stats <스트리머 플레이어> [주간/월간] [페이지]` 스트리머의 후원 통계 조회. 주간은 월요일~일요일, 월간은 1일~말일 기준입니다. (자동완성 지원)

#### 인증 시스템 명령어 (v1.11.8+)
* `/done auth` 웹서버 인증 시도 (개발자가 승인 후 사용)
* `/done status` 인증 상태 확인
* `/done test` 연결 테스트
* `/done reload` 설정 리로드 및 인증 재시도

**주의**: 
- 인증되지 않은 서버에서는 후원 기능이 비활성화됩니다.
- 서버 등록은 마인크래프트 서버 시작 시 자동으로 처리됩니다.
- 등록 후 웹 대시보드에서 승인을 받아야 `/done auth`로 인증할 수 있습니다.

## **자동연결 설정**

config.yml 파일에 다음과 같이 설정:

```yaml
# 자동연결 설정
# - true: 서버 시작 시 모든 채널 자동 연결
# - false: 플레이어 접속 시에만 해당 플레이어 채널 연결
자동연결: false
```

* 기본값은 `false`로 설정되며, 이 경우 방송인 플레이어가 서버에 접속할 때만 해당 채널이 연결됩니다.
* 설정값을 `true`로 변경하거나 `/done autoconnect` 명령어를 사용하여 모든 채널을 자동으로 연결할 수 있습니다.

## **리소스 최적화**

* 자동연결을 `false`로 설정하면 실제 접속한 방송인의 채널만 연결되어 서버 리소스를 절약할 수 있습니다.
* 방송인이 서버에서 나갈 때 자동으로 해당 채널 연결이 해제됩니다.

## **후원 데이터 관리**

* 플러그인 실행 시 `plugins/done-connector/data/` 디렉토리가 자동으로 생성됩니다.
* 각 스트리머의 후원 데이터는 `{플레이어UUID}.yml` 파일로 저장됩니다.
* 실제 후원과 테스트 후원이 구분되어 저장되며, 랭킹 조회 시 테스트 후원은 제외됩니다.
* 후원 데이터에는 후원자명, 후원금액, 후원메시지, 플랫폼, 시간 등이 포함됩니다.

## **후원 랭킹 기능**

* `/done ranking <스트리머 플레이어> [페이지]` 명령어로 후원 랭킹을 조회할 수 있습니다.
* 페이지당 10명씩 표시되며, 후원금액 순으로 정렬됩니다.
* 1위는 금색, 2위는 은색, 3위는 동색으로 표시됩니다.
* 오프라인 플레이어의 랭킹도 조회 가능합니다.

## **통계 기능**

* `/done stats <스트리머 플레이어> [주간/월간] [페이지]` 명령어로 후원 통계를 조회할 수 있습니다.
* **주간 통계**: 월요일~일요일 기준으로 1페이지는 이번 주, 2페이지는 지난 주 순으로 표시됩니다.
* **월간 통계**: 1일~말일 기준으로 1페이지는 이번 달, 2페이지는 지난 달 순으로 표시됩니다.
* 각 기간별로 총 후원금액, 후원자 수, 평균 후원금액이 요약되어 표시됩니다.
* 해당 기간의 후원자 랭킹도 함께 표시됩니다.
* 테스트 후원은 통계에서 제외됩니다.
* 데이터가 없는 기간의 경우 적절한 안내 메시지가 표시됩니다.
* 기간 옵션을 생략하면 기본적으로 월간 통계가 표시됩니다.

## **인증 시스템 (v1.11.2+)**

### 개요
플러그인은 웹서버 기반 인증 시스템을 통해 승인된 서버에서만 작동합니다. 이는 무단 사용을 방지하고 라이선스 관리를 위한 보안 기능입니다.

### 인증 요구사항
- **외부 IP 주소**: 공유기 내부 IP(192.168.x.x)는 사용할 수 없습니다
- **웹서버 등록**: 서버 정보를 웹 대시보드에 등록해야 합니다
- **인증 확인**: 플러그인 시작 시 자동으로 인증을 시도합니다

### 인증 프로세스
1. **서버 시작 시 자동 등록**: 플러그인이 외부 IP 주소를 자동 조회하여 웹서버에 서버 등록
2. **웹 대시보드 승인**: 개발자가 웹 대시보드에서 등록된 서버를 승인
3. **수동 인증**: 승인 후 `/done auth` 명령어로 인증 시도
4. **기능 활성화**: 인증 성공 시 플러그인 기능 활성화
5. **정기 확인**: 1시간마다 및 매일 0시에 자동으로 인증 상태 확인

### 설정 파일
config.yml에 인증 관련 설정이 자동으로 추가됩니다:

```yaml
인증:
  활성화: true
  웹서버_주소: "https://gameboy.kr"
  시간대: "Asia/Seoul"
  자동_확인_시간: 0  # 00:00 KST
  주기적_확인_간격: 60  # 60분
  유예_기간: 30  # 30분
  엄격_모드: true
  재시도_횟수: 3
  재시도_지연: 5  # 5초
  디버그_모드: false
  SSL_검증_활성화: true
  속도_제한_활성화: true
  파일_무결성_검사_활성화: true
```

### 플러그인 사용 서버 추적 (v1.11.4+)
인증 여부와 상관없이 플러그인을 사용하는 모든 서버를 자동으로 추적합니다:

- **자동 추적**: 플러그인 로드 시 웹서버에 사용 정보 자동 전송
- **통계 제공**: 웹 대시보드에서 플러그인 사용 서버 목록 및 통계 확인
- **실시간 모니터링**: 서버 상태, 플러그인 버전, 최근 활동 등 상세 정보 제공

### 성능 최적화 (v1.11.8+)
100명 이상의 스트리머가 동시 접속하는 대규모 서버를 위한 최적화:

- **스레드 풀 최적화**: 개별 ping 스레드를 공유 스케줄러로 통합 (99개 스레드 절약)
- **메모리 관리**: 자동 정리 시스템으로 메모리 누수 방지
- **병렬 처리**: 연결 및 IP 조회를 병렬로 처리하여 속도 향상
- **동기화 최적화**: 락 범위 최소화로 성능 향상

### 🔍 로그 시스템 (v1.11.8+)

**로그는 모든 개발에서 가장 중요한 기능입니다.** 시스템 운영, 디버깅, 보안, 사용자 행동 분석의 핵심입니다.

#### 인증 확인 스케줄 (v1.11.8+)
- **서버 시작 시**: 즉시 인증 확인
- **5분마다**: 주기적 인증 확인 (강화된 보안)
- **매일 0시**: 일일 인증 확인  
- **수동 명령어**: `/done auth`, `/done reload`

#### 플러그인 로그
- **콘솔 로그**: 서버 콘솔에서 실시간 확인
- **파일 로그**: `plugins/done-connector/logs/` 디렉토리
- **웹 로그**: 웹 대시보드의 "최근 활동 로그"

#### 로그 유형
- **🔌 플러그인 로드**: 서버 시작 시 플러그인 로드 기록
- **💓 하트비트**: 주기적 상태 확인 기록
- **🔐 인증 관련**: 인증 성공/실패, 재인증 기록
- **📡 연결 상태**: 웹소켓 연결/해제, 네트워크 오류
- **💰 후원 처리**: 치즈크/숲 후원 수신 및 처리 기록

#### 관리자 활동 로그
- **🔐 서버 인증**: 관리자의 서버 인증 승인
- **📝 라이선스 변경**: 라이선스 타입 변경 이력
- **🗑️ 라이선스 제거**: 라이선스 삭제 기록
- **🚫 인증 취소**: 서버 인증 해제 기록

#### 로그 활용
```
# 실시간 로그 모니터링
tail -f plugins/done-connector/logs/latest.log

# 인증 관련 로그만 필터링
grep "인증\|auth" plugins/done-connector/logs/latest.log

# 오류 로그만 필터링
grep "ERROR\|오류" plugins/done-connector/logs/latest.log

# 특정 날짜 로그 확인
grep "2025-09-20" plugins/done-connector/logs/latest.log
```

#### 중요 원칙
1. **모든 중요한 동작은 반드시 로그 기록**
2. **로그 레벨 구분**: DEBUG, INFO, WARN, ERROR
3. **개인정보 보호**: 민감한 정보는 마스킹 처리
4. **성능 고려**: 과도한 로그는 성능에 영향
5. **로테이션**: 로그 파일 크기 관리 및 자동 정리

### 문제 해결
- **외부 IP 조회 실패**: 인터넷 연결을 확인하고 방화벽 설정을 점검하세요
- **서버 등록 실패**: 네트워크 연결을 확인하고 웹서버 접근 가능 여부를 점검하세요
- **인증 실패**: 웹 대시보드에서 서버가 승인되어 있는지 확인하세요
- **내부 IP 오류**: 공유기 환경에서는 외부 IP를 사용해야 합니다
- **플러그인 기능 비활성화**: `/done auth` 명령어로 재인증을 시도하세요
- **로그 확인 필수**: 문제 발생 시 반드시 로그를 먼저 확인하세요
- **5분 인증 확인**: 인증 취소 시 최대 5분 내 기능 비활성화